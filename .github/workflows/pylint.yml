name: Pylint and Test Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint pytest pytest-cov
        # Install main package in development mode to ensure proper module imports
        if [ -f movie_idea_generator/pyproject.toml ]; then
          pip install -e ./movie_idea_generator[dev]
        fi
        if [ -f recommender_api/requirements.txt ]; then
          pip install -r recommender_api/requirements.txt
        fi
        # Install any additional requirements
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
    
    - name: Analyzing code with pylint
      run: |
        # Set minimum score threshold (8.0/10)
        THRESHOLD=8.0
        
        # Create a report file
        mkdir -p pylint_reports
        
        # Run pylint and capture the output and score
        # Exclude files containing secrets, virtual environments, and cache directories
        PYLINT_OUTPUT=$(pylint --output-format=text $(find . -type f -name "*.py" ! -path "*/\.*" ! -path "*/venv/*" ! -path "*/.venv/*" ! -path "*/secrets.py" ! -path "*/__pycache__/*") 2>&1)
        echo "$PYLINT_OUTPUT" > pylint_reports/pylint_report.txt
        
        # Extract score from pylint output
        SCORE=$(echo "$PYLINT_OUTPUT" | grep -oP "Your code has been rated at \K[0-9.]+")
        
        if (( $(echo "$SCORE < $THRESHOLD" | bc -l) )); then
          echo "Pylint score $SCORE is below threshold $THRESHOLD"
          exit 1
        else
          echo "Pylint score $SCORE meets or exceeds threshold $THRESHOLD"
        fi
    
    - name: Run tests for movie_idea_generator
      if: ${{ always() }}  # Run even if pylint step fails
      run: |
        if [ -d movie_idea_generator ]; then
          cd movie_idea_generator
          # Check if PYTHONPATH needs to be set for proper imports
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          # Run tests with coverage and fail if tests fail
          python -m pytest tests/ -v --cov=src || exit 1
        fi
    
    - name: Run tests for recommender_api
      if: ${{ always() }}  # Run even if previous steps fail
      run: |
        if [ -d recommender_api ]; then
          cd recommender_api
          # Check if PYTHONPATH needs to be set for proper imports
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          # Run tests with coverage and fail if tests fail
          python -m pytest tests/ -v --cov=src || exit 1
        fi
    
    - name: Upload test and lint reports
      if: ${{ always() }}
      uses: actions/upload-artifact@v3
      with:
        name: test-and-lint-reports
        path: |
          pylint_reports/
          **/coverage.xml
          **/.coverage
